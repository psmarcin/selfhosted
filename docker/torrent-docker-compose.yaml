version: "2.4"
services:
  vpn:
    image: ghcr.io/bubuntux/nordlynx:latest
    container_name: nordlynx
#    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1  # Recommended if using ipv4 only
    environment:
      - PRIVATE_KEY=${PRIVATE_KEY} #required
      - ALLOWED_IPS=0.0.0.0/1,128.0.0.0/1
      - NET_LOCAL=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
      - "POST_UP=ip -4 route add $$(wg | awk -F'[: ]' '/endpoint/ {print $$5}') via $$(ip route | awk '/default/ {print $$3}')"
      - "PRE_DOWN=ip -4 route del $$(route -n | awk '/255.255.255.255/ {print $$1}') via $$(ip route | awk '/default/ {print $$3}')"
    #      - NETWORK=192.168.1.0/24;192.168.50.52/24
#    restart: unless-stopped
    mem_limit: 256m
    mem_reservation: 50m

  torrent:
    image: ghcr.io/linuxserver/transmission:latest
    network_mode: service:vpn
    labels:
      - traefik.enable=true
      - traefik.http.services.torrent.loadbalancer.server.port=9091
      - traefik.http.routers.torrent.rule=PathPrefix(`/`)
      # - traefik.http.routers.torrent.middlewares=torrent-ipw@docker,torrent-ratelimit@docker
      # - traefik.http.middlewares.torrent-ipw.ipwhitelist.sourcerange=${IP_WHITELIST}
      - "traefik.http.middlewares.torrent-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.torrent-ratelimit.ratelimit.burst=50"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      # - TRANSMISSION_WEB_HOME=/flood-for-transmission/
    volumes:
      - /volume1/docker/transmission:/config
      - /volume1/docker/downloads:/downloads
      - /volume1/docker/transmission/watch:/watch
    depends_on:
      - vpn
    # mem_limit: 128m
    # mem_reservation: 50m